#!/bin/bash

#SBATCH --partition=gpu_a100          # Partition name
#SBATCH --gres=gpu:1                  # Number of GPUs to allocate
#SBATCH --cpus-per-task=8             # Number of CPU cores per task
#SBATCH --gpus=1                      # This line is sometimes optional/redundant
#SBATCH --job-name=peract_env_test    # Job name
#SBATCH --ntasks=1                    # Number of tasks
#SBATCH --time=00:30:00               # Time limit hh:mm:ss
#SBATCH --mem=16000M                  # Memory pool for all cores (16GB)
#SBATCH --output=work/peract_env_test_%A.out  # Standard output

### --- MODULE SETUP / ENVIRONMENT ---
module purge
module load 2023
# Uncomment if your cluster requires Apptainer module
# module load Apptainer/<VERSION>

### --- PREPARE DIRECTORIES ---

### --- COPY TEST ENVIRONMENT SCRIPT ---

### --- ADDITIONAL TEST SCRIPTS ---

# Create a script to test PyRep and CoppeliaSim connection

### --- RUN THE ENVIRONMENT TESTS ---
echo "Starting PerAct environment tests..."

# Run the environment test script
echo "1. Running package verification test..."
apptainer run --nv \
    --pwd /local/work \
    -B $(pwd)/data:/local/data \
    -B $(pwd)/cache:/local/cache \
    -B $(pwd)/work:/local/work \
    -B $(pwd)/src:/local/src \
    -B $(pwd)/scripts:/local/scripts \
    -B $(pwd)/configs:/local/configs \
    -B $(pwd)/assets:/local/assets \
    -B $(pwd)/drema:/local/drema \
    -B $(pwd)/submodules:/local/submodules \
    ./peract-latest.sif \
    python /local/scripts/test_peract_env.py

# Run the PyRep test
echo "2. Testing PyRep with CoppeliaSim..."
apptainer run --nv \
    --pwd /local/work \
    -B $(pwd)/data:/local/data \
    -B $(pwd)/cache:/local/cache \
    -B $(pwd)/work:/local/work \
    -B $(pwd)/src:/local/src \
    -B $(pwd)/scripts:/local/scripts \
    -B $(pwd)/configs:/local/configs \
    -B $(pwd)/assets:/local/assets \
    -B $(pwd)/drema:/local/drema \
    -B $(pwd)/submodules:/local/submodules \
    ./peract-latest.sif \
    python /local/scripts/test_pyrep.py

echo "PerAct environment tests completed!"
